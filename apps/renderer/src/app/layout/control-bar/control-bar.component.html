<div class="control-wrapper">
  <!-- Generate/Regenerate bar (full width, above bottom bar) -->
  @if (showGenerateBtn && !transcriptOpen && !chatOpen) {
    <div class="generate-bar">
      @if (showDirectiveInput) {
        <div class="directive-container">
          <span class="directive-label">INSTRUCTIONS POUR LA REGENERATION :</span>
          <textarea
            class="directive-input"
            id="directive-textarea"
            [(ngModel)]="regenerateDirective"
            (keydown.escape)="showDirectiveInput = false; regenerateDirective = ''"
            rows="3"
            placeholder="Ex: Remplacer 'Jean' par 'Jean-Marc', se concentrer sur les actions et decisions, ajouter une section participants..."
          ></textarea>
          <div class="directive-actions">
            <button class="directive-cancel-btn" (click)="showDirectiveInput = false; regenerateDirective = ''">ANNULER</button>
            <button class="directive-submit-btn" (click)="onEnhanceWithDirective()">REGENERER</button>
          </div>
        </div>
      }
      <button
        class="generate-btn"
        [class.processing]="status === 'processing'"
        [disabled]="status === 'processing'"
        (click)="onEnhanceClick()"
      >
        @if (status === 'processing') {
          <sdn-glitch-loader
            [messages]="['EN COURS...']"
            [typingSpeed]="60"
            [glitchDuration]="99999"
            [showCursor]="false"
          ></sdn-glitch-loader>
        } @else {
          <span>{{ hasAiSummary ? 'REGENERER' : 'RESUMER' }}</span>
        }
      </button>
    </div>
  }

  <!-- Bottom bar (audio pill + main pill side by side) -->
  <div class="bottom-bar" [class.expanded]="chatOpen || transcriptOpen">
    <!-- Audio pill (detached) -->
    <div class="audio-column">
      <!-- Audio pill (detached) -->
      <div class="audio-pill" [class.active]="isRecording" [class.disabled]="isRecordingElsewhere">
      <div class="vu-wrapper">
        <div class="vu-kitt">
          <!-- Left column (5 segments) -->
          <div class="vu-column vu-column-side">
            @for (seg of [0,1,2,3,4]; track seg) {
              <div class="vu-segment" [class.lit]="isSegmentLit(0, seg)"></div>
            }
          </div>
          <!-- Center column (8 segments) -->
          <div class="vu-column vu-column-center">
            @for (seg of [0,1,2,3,4,5,6,7]; track seg) {
              <div class="vu-segment" [class.lit]="isSegmentLit(1, seg)"></div>
            }
          </div>
          <!-- Right column (5 segments) -->
          <div class="vu-column vu-column-side">
            @for (seg of [0,1,2,3,4]; track seg) {
              <div class="vu-segment" [class.lit]="isSegmentLit(2, seg)"></div>
            }
          </div>
        </div>
        <!-- Tooltip: Step 1 - Record -->
        <sdn-guide-tooltip
          [visible]="tooltipStep === 'record'"
          [text]="getTooltipText()"
          position="top"
          [step]="getTooltipStepNumber()"
          [isLast]="false"
          (next)="onTooltipNext()"
          (skip)="onTooltipSkip()"
        ></sdn-guide-tooltip>
      </div>
      @if (isRecording) {
        <button class="stop-btn" (click)="toggleRecording()" title="Stop">
          <span class="stop-square"></span>
        </button>
      } @else {
        <button class="rec-btn" (click)="!isRecordingElsewhere && toggleRecording()" [class.disabled]="isRecordingElsewhere">
          <span class="rec-dot"></span>
        </button>
      }
      <div class="chevron-wrapper">
        <button class="chevron-btn" [class.open]="transcriptOpen" (click)="showTranscript.emit()" [title]="'transcript.title' | translate">
          <svg width="10" height="10" viewBox="0 0 10 10" fill="none" stroke="currentColor" stroke-width="1.5">
            <polyline points="3,2 7,5 3,8"/>
          </svg>
        </button>
        <!-- Tooltip: Step 2 - Transcript -->
        <sdn-guide-tooltip
          [visible]="tooltipStep === 'transcript'"
          [text]="getTooltipText()"
          position="top"
          [step]="getTooltipStepNumber()"
          [isLast]="false"
          (next)="onTooltipNext()"
          (skip)="onTooltipSkip()"
        ></sdn-guide-tooltip>
      </div>
    </div>
    </div>

    <!-- Main pill â€” always present, expands upward -->
    <div class="main-pill" [class.expanded]="chatOpen || transcriptOpen">
      <!-- Transcript body (expanded content) -->
      @if (transcriptOpen) {
        <div class="pill-body">
          <div class="pill-header">
            <span class="pill-header-title">{{ 'transcript.title' | translate }}</span>
            <div class="pill-header-actions">
              @if (elapsed > 0) {
                <span class="pill-timer">{{ formatElapsed(elapsed) }}</span>
              }
              <button class="pill-header-btn" (click)="closeTranscript.emit()" [title]="'transcript.minimize' | translate">
                <svg width="12" height="12" viewBox="0 0 12 12" fill="none" stroke="currentColor" stroke-width="1.5">
                  <line x1="2" y1="6" x2="10" y2="6"/>
                </svg>
              </button>
            </div>
          </div>
          <sdn-transcript-panel></sdn-transcript-panel>
        </div>
      }

      <!-- Chat body (expanded content, includes its own input) -->
      @if (chatOpen) {
        <sdn-chat-panel
          [initialPrompt]="chatInitialPrompt"
          (closePanel)="closeChat.emit()"
        ></sdn-chat-panel>
      }

      <!-- Input bar (hidden when chat or transcript is open) -->
      @if (!chatOpen && !transcriptOpen) {
        <div class="pill-input">
          <input
            class="chat-input"
            type="text"
            [(ngModel)]="chatInput"
            (keydown.enter)="onChatSubmit()"
            (keydown.escape)="transcriptOpen ? closeTranscript.emit() : null"
            (focus)="onInputFocus()"
            [placeholder]="'chat.placeholder' | translate"
            [disabled]="status === 'processing'"
          />
        </div>
      }
    </div>
  </div>
</div>
