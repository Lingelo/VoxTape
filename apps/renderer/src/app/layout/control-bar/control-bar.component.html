<div class="control-wrapper">
  <!-- Bottom bar (audio pill + main pill side by side) -->
  <div class="bottom-bar" [class.expanded]="chatOpen || transcriptOpen">
    <!-- Left column: Generate button + Audio pill -->
    <div class="audio-column">
      <!-- Generate notes button (above audio pill) -->
      @if (showGenerateBtn) {
        <button
          class="generate-btn"
          [class.processing]="status === 'processing'"
          [disabled]="status === 'processing'"
          (click)="onEnhance()"
        >
          @if (status === 'processing') {
            <span class="spinner"></span>
          }
          {{ status === 'processing' ? 'Résumé en cours...' : 'Résumer' }}
        </button>
      }

      <!-- Audio pill (detached) -->
      <div class="audio-pill" [class.active]="isRecording" [class.disabled]="isRecordingElsewhere">
      <div class="vu-wrapper">
        <div class="vu-bars" tabindex="0" role="button"
          (click)="!isRecordingElsewhere && toggleRecording()"
          (keydown.enter)="!isRecordingElsewhere && toggleRecording()"
          [class.disabled]="isRecordingElsewhere"
          [title]="isRecordingElsewhere ? ('transcript.recordingElsewhere' | translate) : ''">
          @for (bar of vuBars; track $index; let i = $index) {
            <div class="vu-bar"
              [style.height.px]="isRecording ? getBarHeight(i) : 4"
              [style.opacity]="isRecording ? getBarOpacity(i) : 0.4"
            ></div>
          }
        </div>
        <!-- Tooltip: Step 1 - Record -->
        <sdn-guide-tooltip
          [visible]="tooltipStep === 'record'"
          [text]="getTooltipText()"
          position="top"
          [step]="getTooltipStepNumber()"
          [isLast]="false"
          (next)="onTooltipNext()"
          (skip)="onTooltipSkip()"
        ></sdn-guide-tooltip>
      </div>
      <div class="chevron-wrapper">
        <button class="chevron-btn" [class.open]="transcriptOpen" (click)="showTranscript.emit()" [title]="'transcript.title' | translate">
          <svg width="10" height="10" viewBox="0 0 10 10" fill="none" stroke="currentColor" stroke-width="1.5">
            <polyline points="2,6 5,3 8,6"/>
          </svg>
        </button>
        <!-- Tooltip: Step 2 - Transcript -->
        <sdn-guide-tooltip
          [visible]="tooltipStep === 'transcript'"
          [text]="getTooltipText()"
          position="top"
          [step]="getTooltipStepNumber()"
          [isLast]="false"
          (next)="onTooltipNext()"
          (skip)="onTooltipSkip()"
        ></sdn-guide-tooltip>
      </div>
      @if (isRecording) {
        <button class="stop-btn" (click)="toggleRecording()">
          <span class="stop-square"></span>
        </button>
      }
    </div>
    </div>

    <!-- Main pill — always present, expands upward -->
    <div class="main-pill" [class.expanded]="chatOpen || transcriptOpen">
      <!-- Transcript body (expanded content) -->
      @if (transcriptOpen) {
        <div class="pill-body">
          <div class="pill-header">
            <span class="pill-header-title">{{ 'transcript.title' | translate }}</span>
            <div class="pill-header-actions">
              @if (elapsed > 0) {
                <span class="pill-timer">{{ formatElapsed(elapsed) }}</span>
              }
              <button class="pill-header-btn" (click)="closeTranscript.emit()" [title]="'transcript.minimize' | translate">
                <svg width="12" height="12" viewBox="0 0 12 12" fill="none" stroke="currentColor" stroke-width="1.5">
                  <line x1="2" y1="6" x2="10" y2="6"/>
                </svg>
              </button>
            </div>
          </div>
          <sdn-transcript-panel></sdn-transcript-panel>
        </div>
      }

      <!-- Chat body (expanded content, includes its own input) -->
      @if (chatOpen) {
        <sdn-chat-panel
          [initialPrompt]="chatInitialPrompt"
          (closePanel)="closeChat.emit()"
        ></sdn-chat-panel>
      }

      <!-- Input bar (hidden when chat or transcript is open) -->
      @if (!chatOpen && !transcriptOpen) {
        <div class="pill-input">
          <input
            class="chat-input"
            type="text"
            [(ngModel)]="chatInput"
            (keydown.enter)="onChatSubmit()"
            (keydown.escape)="transcriptOpen ? closeTranscript.emit() : null"
            (focus)="onInputFocus()"
            [placeholder]="'chat.placeholder' | translate"
            [disabled]="status === 'processing'"
          />
        </div>
      }
    </div>
  </div>
</div>
